<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Module 5: Lab Instructions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="05-lab-worksheet_files/libs/clipboard/clipboard.min.js"></script>
<script src="05-lab-worksheet_files/libs/quarto-html/quarto.js"></script>
<script src="05-lab-worksheet_files/libs/quarto-html/popper.min.js"></script>
<script src="05-lab-worksheet_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="05-lab-worksheet_files/libs/quarto-html/anchor.min.js"></script>
<link href="05-lab-worksheet_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="05-lab-worksheet_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="05-lab-worksheet_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="05-lab-worksheet_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="05-lab-worksheet_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Module 5: Lab Instructions</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="purpose" class="level1">
<h1>Purpose</h1>
<p>In today’s lab, we will focus on linear regression with a categorical predictor. We will pay special attention to how categorical variables are coded and what that means for our interpretations.</p>
<p>For today’s lab, you will need to load the following libraries.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(papaja) <span class="co">#for formatting p values</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans) <span class="co">#for post-hoc t-tests</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr) <span class="co">#for formatting tables</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="research-scenario" class="level1">
<h1>Research scenario</h1>
<p>We’ll be looking at a dataset comparing different kinds of treatment for depression. In this study, depressed patients (n = 5 per group) were randomly assigned to one of three groups:</p>
<ol type="1">
<li>CBT group</li>
<li>Psychotherapy group</li>
<li>Control group (received no therapy)</li>
</ol>
<p>After 10 weeks, participants’ depression scores were measured (on a scale of 1 = no depression to 12 = severely depressed). Our dataset will have just 2 variables: <code>group</code> (CBT, Psychotherapy, or Control) and <code>depress</code> (depression scores).</p>
<p><strong>NOTE:</strong> <code>1</code> = CBT; <code>2</code> = Psychotherapy; <code>3</code> = Control</p>
<section id="read-in-the-data" class="level2">
<h2 class="anchored" data-anchor-id="read-in-the-data">Read in the data</h2>
<p>First, let’s read in the data and then use <code>View()</code> to check it out.</p>
<p>Today’s dataset is called <code>depression_therapy.csv</code>. Let’s read it in and name it <code>cat_data</code> (i.e., categorical regression data).</p>
<p>The data has 4 columns:</p>
<ul>
<li>group: a numeric indicator of whether they were in the CBT, Psychotherapy, or Control group</li>
<li>depress: participants’ score on the depression measure</li>
</ul>
</section>
<section id="structure-of-the-data" class="level2">
<h2 class="anchored" data-anchor-id="structure-of-the-data">Structure of the data</h2>
<p>The first thing we should check is how the data are structured. We should have a factor called <code>group</code> and a numeric variable for depression scores called <code>depress</code>. Let’s use the function <code>str()</code>.</p>
</section>
<section id="recode-group-as-a-factor" class="level2">
<h2 class="anchored" data-anchor-id="recode-group-as-a-factor">Recode <code>group</code> as a factor</h2>
<p>R thinks that <code>group</code> is an integer, so we need to make it into a factor in order to run our analysis. We can use <code>mutate()</code> and base R’s <code>factor()</code>, which can be used to turn variables into factors.</p>
<p>NOTE: You want to provide labels in the same order as the levels of the factor, so in this case we want them in the order <code>CBT</code>, <code>Psychotherapy</code>, and <code>Control</code> (see above).</p>
<p>Look at the structure of the data again. Now it’s clear that <code>group</code> is a factor variable with the correct levels.</p>
</section>
<section id="descriptives" class="level2">
<h2 class="anchored" data-anchor-id="descriptives">Descriptives</h2>
<p>Next, we’ll get descriptives for each group using two tidyverse functions, <code>group_by()</code> and <code>summarize()</code>. First, you want to group by <code>group</code>, and then you want to summarize with three arguments, mean, sd, and n.&nbsp;We’ll use knitr to make this into a table.</p>
</section>
<section id="visualizing-the-data" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-the-data">Visualizing the data</h2>
<p>There are many ways that you can visualize the data. In ggplot, I recommend adding a <code>geom_boxplot()</code> or <code>geom_violin()</code> layer. You can also use <code>geom_bar()</code> but there are some disadvantages to barplots, and there have even been attempts to <a href="https://thenode.biologists.com/barbarplots/">Bar Bar Plots!</a> from scientific journals.</p>
<p><a href="https://www.r-graph-gallery.com/boxplot.html">This</a> is a good resource for boxplots with ggplot, <a href="https://www.r-graph-gallery.com/violin.html">this</a> is a good resource for violin plots with ggplot, and <a href="https://www.r-graph-gallery.com/barplot.html">this</a> is a good resource for bar plots with ggplot.</p>
<hr>
</section>
<section id="lets-start-by-just-looking-at-variables-with-two-levels." class="level2">
<h2 class="anchored" data-anchor-id="lets-start-by-just-looking-at-variables-with-two-levels.">Let’s start by just looking at variables with two levels.</h2>
<p>Create a new dataset called <code>cat_reduced</code> that includes only the treatment and control groups. Use <code>View()</code> to double check that the data look correct.</p>
<hr>
</section>
</section>
<section id="regression-with-categorical-predictors" class="level1">
<h1>Regression with categorical predictors</h1>
<section id="dummy-coding" class="level2">
<h2 class="anchored" data-anchor-id="dummy-coding">Dummy coding</h2>
<p>Dummy coding is R’s default method. This actually happens under the hood in R when our independent variable is a factor. Let’s run a regression predicting <code>depress</code> from <code>group</code>.</p>
<blockquote class="blockquote">
<p><strong>Question:</strong> What does the F test tell us?</p>
</blockquote>
<p>Here is our regression equation:</p>
<p><span class="math display">\[Depression_i = \beta_0 + \beta_1psychotherapy_i + e_i\]</span></p>
<p>R is creating a dummy variable for us under the hood: <code>groupPsychotherapy</code>. Let’s look at what R is doing.</p>
<p>By default, R treats whatever the first level of the factor variable is as the reference group. In this case, CBT was the first level of <code>group</code> (because it was initially coded as <code>1</code> in our raw data), so the model treated CBT as our reference group.</p>
<p>Here is our regression equation, derived from the output:</p>
<p><span class="math display">\[Depression_i = 7.20 -3.80psychotherapy\]</span></p>
<blockquote class="blockquote">
<p><strong>Question:</strong> Using this equation, determine the mean depression score of each group.</p>
</blockquote>
<p>Now, let’s revisit the output.</p>
<blockquote class="blockquote">
<p><strong>Question:</strong> Interpret the intercept. What does a significant p-value signify?</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Question:</strong> Interpret the slopes. What do the significant p-values signify?</p>
</blockquote>
<p>Now, let’s change the reference level so that Psychotherapy is assigned a 0 and CBT is assigned a 1.</p>
<p>Rerun the model. Compare it to the default model.</p>
<blockquote class="blockquote">
<p><strong>Question:</strong> Interpret the intercept. What does a significant p-value signify?</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Question:</strong> Interpret the slopes. What do the significant p-values signify?</p>
</blockquote>
</section>
<section id="deviation-coding" class="level2">
<h2 class="anchored" data-anchor-id="deviation-coding">Deviation coding</h2>
<p>Now, let’s say we’re interested in the difference between CBT and Psychotherapy. One way we could do this is to use Deviation Coding. There are a few ways we can create our codes, but this is my preferred method:</p>
<section id="create-dummy-variables-with-mutate-and-case_when" class="level3">
<h3 class="anchored" data-anchor-id="create-dummy-variables-with-mutate-and-case_when">Create dummy variables with <code>mutate()</code> and <code>case_when()</code></h3>
<p>Now, we can run the linear model using this new dummy variable as the IV.</p>
<blockquote class="blockquote">
<p><strong>Question:</strong> What does the intercept mean? What does the slope mean?</p>
</blockquote>
<hr>
</section>
</section>
</section>
<section id="now-lets-take-a-look-at-variables-with-more-than-2-levels." class="level1">
<h1>Now, let’s take a look at variables with more than 2 levels.</h1>
<p>For this, we’ll go back to using <code>cat_data</code> as our data file.</p>
<section id="traditional-anova" class="level2">
<h2 class="anchored" data-anchor-id="traditional-anova">Traditional ANOVA</h2>
<p>We will first review how to generate a “traditional ANOVA” table.</p>
<p>To get an ANOVA table, you can use the same <code>lm()</code> as regression, and use <code>anova()</code> to get the ANOVA summary table. Importantly, you want to make sure that the categorical IV is a factor (which we did above).</p>
<p>To calculate post-hod pairwise comparisons between group levels, we can use <code>emmeans::emmeans()</code>. This function takes an <code>lm()</code> output, an equation that indicates we want to perform pairwise t-tests (<code>pairwise</code>) on the left, and the IV (<code>group</code>) on the right, as well as an <code>adjust</code> (e.g.&nbsp;“bonferroni” or “holm”).</p>
<p>Since we are running a lot of tests (and number of tests grow as we add more levels), we need to correct for multiple comparisons so that we don’t have an inflated type I error rate.</p>
<ul>
<li>Bonferroni correction: multiplies the p-values by the number of comparisons. We’ll talk about this more in class on Tuesday!</li>
</ul>
<blockquote class="blockquote">
<p><strong>Question:</strong> Compare the p-values from these two emmeans summaries. What do you notice?</p>
</blockquote>
<hr>
</section>
<section id="regression-with-categorical-predictors-1" class="level2">
<h2 class="anchored" data-anchor-id="regression-with-categorical-predictors-1">Regression with categorical predictors</h2>
<p>Running the ANOVA within a linear regression framework will give us the same information we already got from our regression model, and something more!</p>
</section>
<section id="dummy-coding-1" class="level2">
<h2 class="anchored" data-anchor-id="dummy-coding-1">Dummy coding</h2>
<p>In regression, categorical predictors with more than two levels are broken up into more than one predictor. This actually happens under the hood in R when our independent variable is a factor. Let’s put <code>group</code> as the predictor in our model as before.</p>
<blockquote class="blockquote">
<p><strong>Question:</strong> What does the F test tell us?</p>
</blockquote>
<p>Here is our regression equation:</p>
<p><span class="math display">\[Depression_i = \beta_0 + \beta_1psychotherapy_i +
\beta_2control_i + e_i\]</span></p>
<p>R is creating two dummy variables for us under the hood: <code>groupPsychotherapy</code> and <code>groupControl</code>. Let’s look at what R is doing.</p>
<p>By default, R treats whatever the first level of the factor variable is as the reference group. In this case, CBT was the first level of <code>group</code> (because it was initially coded as <code>1</code> in our raw data), so the model treated CBT as our reference group.</p>
<p>Here is our regression equation, derived from the output:</p>
<p><span class="math display">\[Depression_i = 7.20 -3.80psychotherapy + 2.60control\]</span></p>
<blockquote class="blockquote">
<p><strong>Question:</strong> Using this equation, determine the mean depression score of each group.</p>
</blockquote>
<p>Now, let’s revisit the output.</p>
<blockquote class="blockquote">
<p><strong>Question:</strong> Interpret the intercept. What does a significant p-value signify?</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Question:</strong> Interpret the slopes. What do the significant p-values signify?</p>
</blockquote>
<p>Let’s imagine that we have the following (more intuitive) research questions:</p>
<ol type="1">
<li>Is CBT effective (relative to no therapy)?</li>
<li>Is psychotherapy effective (relative to no therapy)?</li>
</ol>
<blockquote class="blockquote">
<p><strong>Question:</strong> What do want our reference group to be to answer these research questions?</p>
</blockquote>
<p>Now let’s make the appropriate dummy codes. Recall that we need <em>k</em>-1 dummy codes (where <em>k</em> is the number of groups). We have 3 groups, so we need 2 dummy codes.</p>
<p>Remember, our decision of how to set the dummy codes (which group to set as the <strong>reference group</strong>) should be guided by our research questions.</p>
<section id="create-dummy-variables-with-mutate-and-case_when-1" class="level3">
<h3 class="anchored" data-anchor-id="create-dummy-variables-with-mutate-and-case_when-1">Create dummy variables with <code>mutate()</code> and <code>case_when()</code></h3>
<p>Now, we can run the linear model using these new dummy variables as the IV’s.</p>
<blockquote class="blockquote">
<p><strong>Question:</strong> What does the intercept mean? What do the slopes mean?</p>
</blockquote>
<p>Another reasonable question might be whether the treatments, on average) are better than the control.</p>
<p>Rules for DIY / Planned Contrasts:</p>
<ol type="1">
<li>Groups coded with positive weights will be compared to groups with negative weights</li>
<li>The sum of weights you use should be zero</li>
<li>If a group is not involved in a comparison, assign it a weight of 0</li>
<li>Initial weight assigned to groups should be equal to # groups in opposite chunk of variation</li>
<li>To get final weights, divide initial weight by number of groups with non-zero weights</li>
</ol>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">Step</th>
<th style="text-align: left;">CBT and Psychotherapy</th>
<th style="text-align: left;">Control</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Positive vs.&nbsp;Negative</td>
<td style="text-align: left;">Positive</td>
<td style="text-align: left;">Negative</td>
</tr>
<tr class="even">
<td style="text-align: left;">Initial Weights</td>
<td style="text-align: left;">1, 1</td>
<td style="text-align: left;">-2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Final Weights</td>
<td style="text-align: left;">1/3, 1/3</td>
<td style="text-align: left;">-2/3</td>
</tr>
</tbody>
</table>
</section>
<section id="heres-an-alternative-way-to-create-contrasts-using-a-matrix." class="level3">
<h3 class="anchored" data-anchor-id="heres-an-alternative-way-to-create-contrasts-using-a-matrix.">Here’s an alternative way to create contrasts, using a matrix.</h3>
<blockquote class="blockquote">
<p><strong>Question:</strong> What does the intercept mean? What do the slopes mean?</p>
</blockquote>
<p>We can have k-1 contrasts. So, we might want to add another contrast testing the two treatment groups. We can do the same thing to add another contrast.</p>
<p>Now, write up an APA Style Summary!</p>
<p>We ran a linear regression to examine the effect of different kinds of treatment on depression. We used custom contrast coding to examine the difference between the average of the treatment groups and the control group (CBT: 1/3, Psychotherapy: 1/3, Control: -2/3) and between the two types of treatment (CBT: 1/2, Psychotherapy: -1/2, Control: 0). Our omnibus test revealed a significant effect of treatment group on depression scores, F(2, 12) = 18.95, <em>p</em> &lt; .001), and the model explained a substantial proportion of variance in weight, with an R<sup>2</sup> = 0.7595308 and an adjusted R<sup>2</sup> = 0.7194526. Participants in a treatment group (<em>M</em> = 5.3, <em>SD</em> = 2.5) had significantly lower depression scores than participants in the control group (<em>M</em> = 9.8, <em>SD</em> = 1.79), <span class="math inline">\(\beta\)</span> = -4.5, 95% CI[-6.47, -2.53], <em>p</em> &lt; .001. Within treatment groups, participants who received CBT (<em>M</em> = 7.2, <em>SD</em> = 1.3) had significantly higher depression scores than participants who received Psychotherapy (<em>M</em> = 3.4, <em>SD</em> = 1.82), <span class="math inline">\(\beta\)</span> = -2.6870058, 95% CI[-4.3, -1.08], <em>p</em> =.003. In summary, we found that treatment had an effect on participants’ depression scores and Psychotherapy may be a better treatment option than CBT.</p>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>